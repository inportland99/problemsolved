---
layout: minimal.njk
title: Math Lessons Library
description: Browse and manage math lessons for problem-based learning
---

<div class="min-h-screen bg-base-200">
  <!-- Header -->
  <div class="navbar bg-base-100 shadow-lg">
    <div class="flex-1">
      <a href="/" class="btn btn-ghost normal-case text-xl">üìê Math Lessons</a>
    </div>
    <div class="flex-none">
      <a href="/lessons-edit/" class="btn btn-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New Lesson
      </a>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- Alert messages -->
    <div id="alert-container" class="mb-4"></div>

    <!-- Loading state -->
    <div id="loading" class="flex justify-center items-center py-12">
      <span class="loading loading-spinner loading-lg"></span>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="text-6xl mb-4">üìê</div>
      <h2 class="text-2xl font-bold mb-2">No lessons yet</h2>
      <p class="text-gray-600 mb-6">Start by creating your first math lesson!</p>
      <a href="/lessons-edit/" class="btn btn-primary">Create First Lesson</a>
    </div>

    <!-- Lessons Grid -->
    <div id="lessons-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Lesson cards will be inserted here -->
    </div>
  </div>
</div>

<!-- View Modal -->
<dialog id="view-modal" class="modal">
  <div class="modal-box max-w-4xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
    </form>
    <h3 class="font-bold text-2xl mb-4" id="view-learning-goal">Learning Goal</h3>
    
    <!-- Diagram -->
    <div id="view-diagram-container" class="mb-6 hidden">
      <img id="view-diagram" src="" alt="Lesson diagram" class="max-w-full h-auto rounded-lg shadow" />
    </div>

    <!-- Task -->
    <div class="mb-6">
      <p class="text-sm font-semibold text-gray-600 mb-2">Task</p>
      <div class="p-4 bg-base-200 rounded-lg">
        <p id="view-task" class="whitespace-pre-wrap"></p>
      </div>
    </div>

    <!-- Launch Details -->
    <div id="view-launch-container" class="mb-6 hidden">
      <p class="text-sm font-semibold text-gray-600 mb-2">Launch Details</p>
      <div class="p-4 bg-base-200 rounded-lg">
        <p id="view-launch" class="whitespace-pre-wrap"></p>
      </div>
    </div>

    <!-- Anticipated Strategies -->
    <div id="view-strategies-container" class="mb-6 hidden">
      <p class="text-sm font-semibold text-gray-600 mb-2">Anticipated Strategies</p>
      <ul id="view-strategies" class="list-disc list-inside space-y-1 p-4 bg-base-200 rounded-lg">
      </ul>
    </div>

    <!-- Connecting Questions -->
    <div id="view-questions-container" class="mb-6 hidden">
      <p class="text-sm font-semibold text-gray-600 mb-2">Connecting Questions</p>
      <ul id="view-questions" class="list-disc list-inside space-y-1 p-4 bg-base-200 rounded-lg">
      </ul>
    </div>

    <!-- Author & Date -->
    <div class="text-sm text-gray-500 border-t pt-4">
      <span id="view-author"></span> ¬∑ <span id="view-date"></span>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
</dialog>

<!-- Delete Confirmation Modal -->
<dialog id="delete-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Delete Lesson?</h3>
    <p class="mb-4">Are you sure you want to delete this lesson? This action cannot be undone.</p>
    <input type="hidden" id="delete-lesson-id">
    <div class="modal-action">
      <button id="confirm-delete-btn" class="btn btn-error">Delete</button>
      <form method="dialog">
        <button class="btn">Cancel</button>
      </form>
    </div>
  </div>
</dialog>

<script type="module">
import { getAllLessons, deleteLesson } from '/assets/js/lessons-db.js';

// Alert helper
function showAlert(message, type = 'info') {
  const container = document.getElementById('alert-container');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} shadow-lg`;
  alert.innerHTML = `<span>${message}</span>`;
  container.appendChild(alert);
  
  setTimeout(() => {
    alert.remove();
  }, 5000);
}

// Format date
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric'
  });
}

// Load and display lessons
async function loadLessons() {
  const loading = document.getElementById('loading');
  const emptyState = document.getElementById('empty-state');
  const grid = document.getElementById('lessons-grid');
  
  loading.classList.remove('hidden');
  emptyState.classList.add('hidden');
  grid.classList.add('hidden');
  
  const result = await getAllLessons();
  
  loading.classList.add('hidden');
  
  if (!result.success) {
    showAlert(result.error?.message || 'Failed to load lessons', 'error');
    return;
  }
  
  if (result.data.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }
  
  grid.classList.remove('hidden');
  grid.innerHTML = result.data.map(lesson => createLessonCard(lesson)).join('');
  
  // Attach event listeners
  result.data.forEach(lesson => {
    document.getElementById(`view-${lesson.id}`).addEventListener('click', () => openViewModal(lesson));
    document.getElementById(`edit-${lesson.id}`).addEventListener('click', () => {
      window.location.href = `/lessons-edit/?id=${lesson.id}`;
    });
    document.getElementById(`delete-${lesson.id}`).addEventListener('click', () => openDeleteModal(lesson));
  });
}

// Create lesson card HTML
function createLessonCard(lesson) {
  const hasDiagram = lesson.diagram_url;
  const strategiesCount = lesson.anticipated_strategies?.length || 0;
  const questionsCount = lesson.connecting_questions?.length || 0;
  
  return `
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
      ${hasDiagram ? `
        <figure class="h-48 overflow-hidden">
          <img src="${lesson.diagram_url}" alt="Lesson diagram" class="w-full h-full object-cover" />
        </figure>
      ` : ''}
      <div class="card-body">
        <h2 class="card-title text-lg line-clamp-2">${lesson.learning_goal}</h2>
        
        <p class="text-sm text-gray-600 line-clamp-3">${lesson.task}</p>
        
        <div class="flex gap-2 mt-2">
          ${strategiesCount > 0 ? `<div class="badge badge-outline">${strategiesCount} strategies</div>` : ''}
          ${questionsCount > 0 ? `<div class="badge badge-outline">${questionsCount} questions</div>` : ''}
        </div>
        
        <div class="text-xs text-gray-500 mt-2">
          ${lesson.author} ¬∑ ${formatDate(lesson.created_at)}
        </div>
        
        <div class="card-actions justify-end mt-4">
          <button id="view-${lesson.id}" class="btn btn-sm btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            View
          </button>
          <button id="edit-${lesson.id}" class="btn btn-sm btn-outline btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
          <button id="delete-${lesson.id}" class="btn btn-sm btn-outline btn-error">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  `;
}

// Open view modal
function openViewModal(lesson) {
  document.getElementById('view-learning-goal').textContent = lesson.learning_goal;
  document.getElementById('view-task').textContent = lesson.task;
  
  // Diagram
  const diagramContainer = document.getElementById('view-diagram-container');
  if (lesson.diagram_url) {
    document.getElementById('view-diagram').src = lesson.diagram_url;
    diagramContainer.classList.remove('hidden');
  } else {
    diagramContainer.classList.add('hidden');
  }
  
  // Launch details
  const launchContainer = document.getElementById('view-launch-container');
  if (lesson.launch_details) {
    document.getElementById('view-launch').textContent = lesson.launch_details;
    launchContainer.classList.remove('hidden');
  } else {
    launchContainer.classList.add('hidden');
  }
  
  // Strategies
  const strategiesContainer = document.getElementById('view-strategies-container');
  if (lesson.anticipated_strategies?.length > 0) {
    document.getElementById('view-strategies').innerHTML = 
      lesson.anticipated_strategies.map(s => `<li>${s}</li>`).join('');
    strategiesContainer.classList.remove('hidden');
  } else {
    strategiesContainer.classList.add('hidden');
  }
  
  // Questions
  const questionsContainer = document.getElementById('view-questions-container');
  if (lesson.connecting_questions?.length > 0) {
    document.getElementById('view-questions').innerHTML = 
      lesson.connecting_questions.map(q => `<li>${q}</li>`).join('');
    questionsContainer.classList.remove('hidden');
  } else {
    questionsContainer.classList.add('hidden');
  }
  
  // Author and date
  document.getElementById('view-author').textContent = lesson.author;
  document.getElementById('view-date').textContent = formatDate(lesson.created_at);
  
  document.getElementById('view-modal').showModal();
}

// Open delete modal
function openDeleteModal(lesson) {
  document.getElementById('delete-lesson-id').value = lesson.id;
  document.getElementById('delete-modal').showModal();
}

// Confirm delete
document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
  const lessonId = document.getElementById('delete-lesson-id').value;
  
  const result = await deleteLesson(lessonId);
  
  document.getElementById('delete-modal').close();
  
  if (result.success) {
    showAlert('Lesson deleted successfully', 'success');
    loadLessons();
  } else {
    showAlert(result.error?.message || 'Failed to delete lesson', 'error');
  }
});

// Initialize
loadLessons();
</script>
